{% extends 'layout.html' %}

{% block content %}
{% load crispy_forms_tags %}

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>



    #file-upload-input {
        display: none;
    }

    #file-upload-button:hover {
        background-color: gray;
    }

    #file-upload-button:focus {
        box-shadow:none;
      }
      
    #file-upload-button:active{
        transform: perspective(20px) translateZ(-1px);
      }

    #file-upload-button {
        padding-right:15px;
        padding-left: 15px;
        background-color:dimgray;
        border:none;
        margin-top : 50px;
        color: white;
        border-radius: 5px;
    }

 

    .player-button {
        border:none;
        background-color:transparent;
        color:#505050;
        padding:5px;
        padding-right: 10px;
        padding-left: 10px;
        margin-left: 10px;
        margin-right: 10px;

    }

    .player-button:focus {
        color: #505050
        background-color:transparent;

    }

    .player-button:visited {
        color: #505050
        background-color:transparent;

    }

    .player-button:active {
        color: white;
        border:none;
        background-color: transparent;
    }

    .player-button:hover {
        background-color: transparent;
        color: black !important;
    }


    .edit-button {
        margin:5px;
        padding:10px;
        background-color:darkgray;
        border:none;
        border-radius: 5px;
        padding:5px;
        color: white;
    }

    .edit-button:focus {
        box-shadow:none;
      }
      
      .edit-button:active{
        transform: perspective(20px) translateZ(-1px);
      }

    .edit-button:hover {
        background-color:gray;
        box-shadow: 1px 1px 0px 1px dimgray;

    }

    #player-div {
        padding:-60px;
    }

    #addButton {
        margin: 50px;
        padding-left: 20px;
        padding-right:20px;
        background-color: #4f5d75;
        border: none;
        font-size: 20px;
    }

    #addButton:hover {
        background-color: #2d3142;
    }

    #adButton:focus {
        border:none !important;
      }
      
      #addButton:active{
        transform: perspective(20px) translateZ(-1px);
        border: none !important;
      }


    .headingRow{
        padding-top: 30px;
        color: black;
      
      }

.fa-question {
    color: #2d3142;
  }

  
  #helpButton {
    background-color: white !important;
    margin-top: 60px;
    border: 2px dashed #2d3142 !important;
  }

  #helpButton:hover {
      box-shadow: 3px 3px 3px 1px dimgray;

  }

  #helpButton:focus {
    box-shadow:none;
  }
  
  #helpButton:active{
    transform: perspective(20px) translateZ(-1px);
  }

  .popUp {
    text-align: center;
    display: none;
    position: fixed;
    padding-top: 170px;
    top: 0;
    width: 100%;
    height: 175%;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 99999;
  }
  .popupContent {
    margin-top: 150px;
    font-size: 17px;
    background-color: #fefefe;
    margin: auto;
    padding: 30px;
    padding-right: 25px;
    border: 1px solid #888;
    width: 65%;
  }
  .close {
    color: rgb(255, 65, 65);
    float: right;
    font-size: 40px;
    font-weight: bold;
  }
  .close:hover, .close:focus {
    color: #ff1010;
    cursor: pointer;
  }
</style>

<div class="popUp">
    <div class="popupContent">
    <span class="close">Ã—</span>
    To start editing an audio file you can either:<br>
    1. Upload an audio from your device by clicking the "Choose File" button.<br>
    2. Record an audio by clicking the <i class="fa-solid fa-circle fa-lg" style="color:#505050;"></i> button under the editor.<br>
    <br>The editor has multiple options:<br>
    <b>Trim</b> - removes the audio outside the moveable bars of the editor (can be set by user).<br>
    <b>Remove Section</b> - removes the audio inside the moveable bars of the editor (can be set by user).<br>
    <b>Remove Silence</b> - automatically removes the silence at the start and end of the audio.<br>
    <b>Revert</b> - undos all the edits and reverts the audio back to its initial state.
    <br><br>
    Once you are happy with your audio, fill out the textbox with the name you want to save it
      as and click on the 'Add Audio' button.<br><br>
     As well as being stored, the audio is also listed as a downloadable link on the right under "Added Files".
  </div>
    </div>


    {% comment %} <div class="row">
        <div class="col-md-4"></div>
        <div class="col-md-4 d-flex justify-content-center">
            <button class="openPopUp" id="helpButton"><i class=" fa-solid fa-question fa-lg"></i></button>

        </div> {% endcomment %}
    <div class="row headingRow">
        <div class="col-md-2"></div>
        <div class="col-md-8 d-flex justify-content-center heading">
          <h1>Create, Edit and Submit Audios</h1>
        </div>
    </div>
 
    <div class='row mt-5'>
        <div class="col-md-4">
        </div>

        <div id="word-name-container" class="col-md-4 d-flex justify-content-center">
            <form action="" enctype="multipart/form-data" id="audioForm" method="POST">
                {% csrf_token %}
                <div class="form-outline">
                    <input type="text" id="name" name="name"class="form-control" maxlength="20" placeholder="Enter Audio Name" />
                </div>
                <input id="file-upload-input" type="file" />
            </form>
            
        </div>

        
        {% load static %}
        <link rel="stylesheet" href="{% static 'assets/css/recorder.css' %}">  
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    </div>
    <div class="row mt-5">
        <div class="col-md-4">
        </div>
        <div class="col-md-4 d-flex justify-content-center">
            <button class=" trim-left edit-button" onclick="trimLeft()" style:"margin:5px">
                Trim
            </button>
            <button class=" trim-left edit-button" onclick="deleteChunk()">
                Remove Section
            </button>
            <button class="trim-left edit-button" onclick="removeSilence()">
                Remove Silence
            </button>
            <button class=" trim-left edit-button" onclick="revert()">
                Revert
            </button>
        </div>
    </div> 
    <div class="row">
        <div class="col-md-3"></div>    
            <div class="col-md-1">
            <button id="file-upload-button" type="button">
                Choose File
            </button>
            
        </div>
        
        <div class="col-md-4" style="padding:10px">
            <div class="waveform-container" style="background:lightgray !important">
                <div id="waveform"></div>
            </div>
            <audio hidden id="myAudio" class="video-js vjs-default-skin"></audio>
        </div>
        <div class="col-md-1">
            <button class="openPopUp" id="helpButton"><i class=" fa-solid fa-question fa-lg"></i></button>
          </div>
        <div class="col-md-3">
            <h3>Added Files</h3> <br>
            <ol id="recordingsList"></ol>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4" >
        </div>
        <div id="player-div" class="col-md-4 d-flex justify-content-center">
            <button id="recordButton" class=" player-button" onclick="startRecording(event)">
                <i class="fa-solid fa-circle fa-lg"></i>
            </button>
            <button id= "playButton" class=" player-button" onclick="playRegion()">
                <i class="fa-solid fa-play fa-lg"></i>
                /
                <i class="fa-solid fa-pause fa-lg"></i>
            </button>
            <button class=" player-button" onclick="wavesurfer.stop()">
                <i class="fa-solid fa-stop fa-lg"></i>
            </button>
        </div>
    </div>

    <div class="row">
        <p>
        <div class="col-md-4"></div>
        <div class="col-md-4 d-flex justify-content-center">
            <!-- button that triggers a link to the audio to be displayed.
                Ideally this button will also send a POST request. -->

            <button id="addButton" class="btn btn-primary trim-left" onclick="saveAudio()">
                Add Audio
            </button>
        </div>
        </p>
        
        <!-- inserting these scripts at the end to be able to use all the elements in the DOM --> 
        <!-- <link href="//unpkg.com/video.js@7.14.3/dist/video-js.min.css" rel="stylesheet"> -->
        <link href="//unpkg.com/videojs-wavesurfer/dist/css/videojs.wavesurfer.min.css" rel="stylesheet">

        <!-- the following are library scripts for wavesurfer, recording and editing -->
        <script src="//unpkg.com/video.js@7.14.3/dist/video.min.js"></script>
        <script src="//unpkg.com/recordrtc/RecordRTC.js"></script>
        <script src="//unpkg.com/webrtc-adapter/out/adapter.js"></script>
        <script src="//unpkg.com/wavesurfer.js/dist/wavesurfer.min.js"></script>
        <script src="//unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.microphone.min.js"></script>
        <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
        <script src="//unpkg.com/videojs-wavesurfer/dist/videojs.wavesurfer.min.js"></script>
        <script src="//unpkg.com/videojs-record/dist/videojs.record.min.js"></script>

        <!-- local script for wavesurfer, recording and editing -->
        {% load static %}
        <script src="{%static '/assets/js/recorder.js'%}" type="text/javascript"></script>

        <!-- can't remember what this is for -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

        <script>

            function removeSilence() {
                if (!url){
                    url = bufferToWave(wavesurfer.backend.buffer, 0, wavesurfer.backend.buffer.length);
                }
                var audioBlob = bufferToWave(wavesurfer.backend.buffer, 0, wavesurfer.backend.buffer.length, 1);
                var fd = new FormData();
                fd.append('file', audioBlob);
                $.ajax({
                    type: 'POST',
                    url: "{% url 'trimAudio' %}",
                    headers: {"X-CSRFToken": "{{ csrf_token }}"},
                    data: fd,
                    processData: false,
                    contentType: false
                }).done(function(data) {
<<<<<<< HEAD
                    var path = '/media/'+{{ user.id }}+'/trimmedSounds/trimmedAudio.wav'
=======
                    console.log("trimmedURL")
                    console.log("{{ trimmedUrl }}")
                    var path = '{{ trimmedUrl }}'
>>>>>>> 5169b759ec66ce2d754eaa4db3a2092046f0a20d
                    wavesurfer.load(path);
                });

            }


            function saveAudio() {
                var audioBlobURL = bufferToWave(wavesurfer.backend.buffer, 0, wavesurfer.backend.buffer.length, 0);
                var audioBlob = bufferToWave(wavesurfer.backend.buffer, 0, wavesurfer.backend.buffer.length, 1);
                var li = document.createElement('li');
                var link = document.createElement('a');
                //get the name that's written in input text box
                var name = $("#name").val()

                if (!name) {
                    alert("Must give audio a name")
                }
                else{
                    link.href = audioBlobURL;
                    link.download = name + '.wav';
                    link.innerHTML = link.download;
                    //add the new audio and a elements to the li element 
                    li.appendChild(link);
                    //add the li element to the ordered list 

                    recordingsList.appendChild(li);

                    var fd = new FormData();
                    audioName = name 
                    fd.append('word', audioName);
                    fd.append('file', audioBlob);
                    $.ajax({
                        type: 'POST',
                        url: "{% url 'uploadAudio' %}",
                        headers: {"X-CSRFToken": "{{ csrf_token }}"},
                        data: fd,
                        processData: false,
                        contentType: false
                    }).done(function(data) {
                        console.log(data);
                    });


                /*  var formData = new FormData();
                    audioName = name + '.wav'
                    formData.append('name', name)
                    formData.append('allow_mumble', $("allow_mumble").val())
                    formData.append('file_location', audioBlob)
                    var request = new XMLHttpRequest();
                    request.open("POST", "/uploadAudio/");
                    request.setRequestHeader("X-CSRFToken", "{{ csrf_token }}"); 
                    request.send(formData); */
                }
        
            }

             
  var popUp = document.querySelector(".popUp");
  var btn = document.querySelector(".openPopUp");
  var span = document.querySelector(".close");
  btn.addEventListener("click", () => {
     popUp.style.display = "block";
  });
  span.addEventListener("click", () => {
     popUp.style.display = "none";
  });
  window.onclick = function(event) {
     if (event.target == popUp) {
        popUp.style.display = "none";
     }
  };

        </script>
        <script src="https://kit.fontawesome.com/1b3007e0fe.js" crossorigin="anonymous"></script><br><br>

    </div>


{% endblock %}